name: aunsorm

networks:
  aunsorm-network:
    driver: bridge

services:
  # API Gateway - Main entry point
  gateway:
    container_name: aun-gateway
    build:
      context: .
      dockerfile: Dockerfile.gateway
    image: aunsorm-gateway:local
    env_file:
      - .env
    ports:
      - "50010:50010"
    networks:
      - aunsorm-network
    depends_on:
      - auth-service
      - crypto-service
      - x509-service
      - kms-service
      - mdm-service
      - id-service
      - acme-service
      - pqc-service
      - rng-service
      - blockchain-service
      - e2ee-service
      - metrics-service
      - cli-gateway
    restart: unless-stopped
    environment:
      - AUNSORM_LISTEN=0.0.0.0:50010
      - SERVICE_MODE=gateway

  # Auth Service - JWT/OAuth (Port 50011)
  auth-service:
    container_name: aun-auth-service
    build:
      context: .
      dockerfile: Dockerfile.auth
    image: aunsorm-auth:local
    env_file:
      - .env
    ports:
      - "50011:50011"
    volumes:
      - aunsorm-auth-data:/srv/data
    networks:
      - aunsorm-network
    restart: unless-stopped
    environment:
      - AUNSORM_LISTEN=0.0.0.0:50011
      - SERVICE_MODE=auth-service

  # Crypto Service - Core cryptography (Port 50012)
  crypto-service:
    container_name: aun-crypto-service
    build:
      context: .
      dockerfile: Dockerfile.crypto
    image: aunsorm-crypto:local
    env_file:
      - .env
    ports:
      - "50012:50012"
    networks:
      - aunsorm-network
    restart: unless-stopped
    environment:
      - AUNSORM_LISTEN=0.0.0.0:50012
      - SERVICE_MODE=crypto-service

  # X509 Service - Certificate management (Port 50013)
  x509-service:
    container_name: aun-x509-service
    build:
      context: .
      dockerfile: Dockerfile.x509
    image: aunsorm-x509:local
    env_file:
      - .env
    ports:
      - "50013:50013"
    networks:
      - aunsorm-network
    restart: unless-stopped

  # KMS Service - Key Management (Port 50014)
  kms-service:
    container_name: aun-kms-service
    build:
      context: .
      dockerfile: Dockerfile.kms
    image: aunsorm-kms:local
    env_file:
      - .env
    ports:
      - "50014:50014"
    networks:
      - aunsorm-network
    restart: unless-stopped

  # MDM Service - Mobile Device Management (Port 50015)
  mdm-service:
    container_name: aun-mdm-service
    build:
      context: .
      dockerfile: Dockerfile.mdm
    image: aunsorm-mdm:local
    env_file:
      - .env
    ports:
      - "50015:50015"
    volumes:
      - aunsorm-mdm-data:/srv/data
    networks:
      - aunsorm-network
    restart: unless-stopped
    environment:
      - AUNSORM_LISTEN=0.0.0.0:50015
      - SERVICE_MODE=mdm-service

  # ACME Service - Let's Encrypt (Port 50017)
  acme-service:
    container_name: aun-acme-service
    build:
      context: .
      dockerfile: Dockerfile.acme
    image: aunsorm-acme:local
    env_file:
      - .env
    ports:
      - "50017:50017"
    volumes:
      - aunsorm-acme-data:/srv/data
    networks:
      - aunsorm-network
    restart: unless-stopped
    environment:
      - AUNSORM_LISTEN=0.0.0.0:50017
      - SERVICE_MODE=acme-service

  # ID Service - Identity management (Port 50016)
  id-service:
    container_name: aun-id-service
    build:
      context: .
      dockerfile: Dockerfile.id
    image: aunsorm-id:local
    env_file:
      - .env
    ports:
      - "50016:50016"
    networks:
      - aunsorm-network
    restart: unless-stopped
    environment:
      - AUNSORM_LISTEN=0.0.0.0:50016
      - SERVICE_MODE=id-service

  # PQC Service - Post-Quantum Cryptography (Port 50018)
  pqc-service:
    container_name: aun-pqc-service
    build:
      context: .
      dockerfile: Dockerfile.pqc
    image: aunsorm-pqc:local
    env_file:
      - .env
    ports:
      - "50018:50018"
    networks:
      - aunsorm-network
    restart: unless-stopped

  # RNG Service - Cryptographic Random Number Generator (Port 50019)
  rng-service:
    container_name: aun-rng-service
    build:
      context: .
      dockerfile: Dockerfile.rng
    image: aunsorm-rng:local
    env_file:
      - .env
    ports:
      - "50019:50019"
    networks:
      - aunsorm-network
    restart: unless-stopped

  # Blockchain Service - DID verification and Fabric integration (Port 50020)
  # ------------------------------------------------------------------
  # Dev/Test bootstrapping notes for blockchain anchoring experiments:
  #   1. Kopya alın: `tests/blockchain/config.example.toml` →
  #      `config/blockchain.dev.toml` ve RPC uçlarını kendi dev ağına göre
  #      güncelleyin.
  #   2. `AUNSORM_CLOCK_ATTESTATION` değeri için `crates/server/src/tests.rs`
  #      içindeki `SecureClockSnapshot` örneğini şablon olarak kullanarak bir
  #      JSON üretin; değeri `.env.dev` dosyanıza tek satır olarak ekleyin.
  #   3. Kalibrasyon gereksinimi için `AUNSORM_CALIBRATION_FINGERPRINT`
  #      alanını, ilgili JWE kalibrasyon çıktısının hex parmak izi ile eşleyin.
  #   4. Zincir ve zaman mock'larını başlatmak için
  #      `COMPOSE_PROFILES=mocks docker compose up -d blockchain-service time-source-mock`
  #      komutunu kullanın. `time-source-mock` konteyneri, planlanan dev profili
  #      altında `http://time-source-mock:58080/now` uç noktası üzerinden
  #      `SecureClockSnapshot` JSON'u sunarak blokzincir servisine tutarlı saat
  #      sağlayacaktır.
  #   5. Başlangıçta `docker compose logs -f blockchain-service` ile hizmetin
  #      attestation ve kalibrasyon değerlerini kabul ettiğini doğrulayın.
  blockchain-service:
    container_name: aun-blockchain-service
    build:
      context: .
      dockerfile: Dockerfile.blockchain
    image: aunsorm-blockchain:local
    env_file:
      - .env
    ports:
      - "50020:50020"
    networks:
      - aunsorm-network
    restart: unless-stopped

  # E2EE Service - End-to-End Encryption media sessions (Port 50021)
  e2ee-service:
    container_name: aun-e2ee-service
    build:
      context: .
      dockerfile: Dockerfile.e2ee
    image: aunsorm-e2ee:local
    env_file:
      - .env
    ports:
      - "50021:50021"
    volumes:
      - aunsorm-e2ee-data:/srv/data
    networks:
      - aunsorm-network
    restart: unless-stopped

  # Metrics Service - Prometheus endpoints (Port 50022)
  metrics-service:
    container_name: aun-metrics-service
    build:
      context: .
      dockerfile: Dockerfile.metrics
    image: aunsorm-metrics:local
    env_file:
      - .env
    ports:
      - "50022:50022"
    networks:
      - aunsorm-network
    restart: unless-stopped

  # CLI Gateway Service - REST API for CLI commands (Port 50023)
  cli-gateway:
    container_name: aun-cli-gateway
    build:
      context: .
      dockerfile: Dockerfile.cli-gateway
    image: aunsorm-cli-gateway:local
    env_file:
      - .env
    ports:
      - "50023:50023"
    networks:
      - aunsorm-network
    depends_on:
      - auth-service
      - crypto-service
      - x509-service
    environment:
      - AUNSORM_LISTEN=0.0.0.0:50023
      - SERVICE_MODE=cli-gateway
      - CLI_MAX_FILE_SIZE=100MB
      - CLI_TIMEOUT=300s
      - AUTH_SERVICE_URL=http://auth-service:50011
    restart: unless-stopped

volumes:
  aunsorm-auth-data:
    driver: local
  aunsorm-mdm-data:
    driver: local
  aunsorm-acme-data:
    driver: local
  aunsorm-e2ee-data:
    driver: local
