name: aunsorm

networks:
  aunsorm-network:
    driver: bridge

services:
  # API Gateway - Main entry point
  gateway:
    build:
      context: .
      dockerfile: Dockerfile.gateway
    image: aunsorm-gateway:local
    ports:
      - "50010:50010"
    networks:
      - aunsorm-network
    depends_on:
      - auth-service
      - crypto-service
      - x509-service
      - kms-service
      - mdm-service
      - id-service
      - acme-service
      - pqc-service
      - rng-service
      - blockchain-service
      - e2ee-service
      - metrics-service
      - cli-gateway
    restart: unless-stopped

  # Auth Service - JWT/OAuth (Port 50011)
  auth-service:
    build:
      context: .
      dockerfile: Dockerfile.auth
    image: aunsorm-auth:local
    env_file:
      - .env
    ports:
      - "50011:50011"
    volumes:
      - aunsorm-auth-data:/srv/data
    networks:
      - aunsorm-network
    restart: unless-stopped

  # Crypto Service - Core cryptography (Port 50012)
  crypto-service:
    build:
      context: .
      dockerfile: Dockerfile.crypto
    image: aunsorm-crypto:local
    ports:
      - "50012:50012"
    networks:
      - aunsorm-network
    restart: unless-stopped

  # X509 Service - Certificate management (Port 50013)
  x509-service:
    build:
      context: .
      dockerfile: Dockerfile.x509
    image: aunsorm-x509:local
    ports:
      - "50013:50013"
    networks:
      - aunsorm-network
    restart: unless-stopped

  # KMS Service - Key Management (Port 50014)
  kms-service:
    build:
      context: .
      dockerfile: Dockerfile.kms
    image: aunsorm-kms:local
    ports:
      - "50014:50014"
    networks:
      - aunsorm-network
    restart: unless-stopped

  # MDM Service - Mobile Device Management (Port 50015)
  mdm-service:
    build:
      context: .
      dockerfile: Dockerfile.mdm
    image: aunsorm-mdm:local
    ports:
      - "50015:50015"
    volumes:
      - aunsorm-mdm-data:/srv/data
    networks:
      - aunsorm-network
    restart: unless-stopped

  # ID Service - Identity management (Port 50016)
  id-service:
    build:
      context: .
      dockerfile: Dockerfile.id
    image: aunsorm-id:local
    ports:
      - "50016:50016"
    networks:
      - aunsorm-network
    restart: unless-stopped

  # ACME Service - Let's Encrypt (Port 50017)
  acme-service:
    build:
      context: .
      dockerfile: Dockerfile.acme
    image: aunsorm-acme:local
    ports:
      - "50017:50017"
    volumes:
      - aunsorm-acme-data:/srv/data
    networks:
      - aunsorm-network
    restart: unless-stopped

  # PQC Service - Post-Quantum Cryptography (Port 50018)
  pqc-service:
    build:
      context: .
      dockerfile: Dockerfile.pqc
    image: aunsorm-pqc:local
    ports:
      - "50018:50018"
    networks:
      - aunsorm-network
    restart: unless-stopped

  # RNG Service - Cryptographic Random Number Generator (Port 50019)
  rng-service:
    build:
      context: .
      dockerfile: Dockerfile.rng
    image: aunsorm-rng:local
    ports:
      - "50019:50019"
    networks:
      - aunsorm-network
    restart: unless-stopped

  # Blockchain Service - DID verification and Fabric integration (Port 50020)
  blockchain-service:
    build:
      context: .
      dockerfile: Dockerfile.blockchain
    image: aunsorm-blockchain:local
    ports:
      - "50020:50020"
    networks:
      - aunsorm-network
    restart: unless-stopped

  # E2EE Service - End-to-End Encryption media sessions (Port 50021)
  e2ee-service:
    build:
      context: .
      dockerfile: Dockerfile.e2ee
    image: aunsorm-e2ee:local
    ports:
      - "50021:50021"
    volumes:
      - aunsorm-e2ee-data:/srv/data
    networks:
      - aunsorm-network
    restart: unless-stopped

  # Metrics Service - Prometheus endpoints (Port 50022)
  metrics-service:
    build:
      context: .
      dockerfile: Dockerfile.metrics
    image: aunsorm-metrics:local
    ports:
      - "50022:50022"
    networks:
      - aunsorm-network
    restart: unless-stopped

  # CLI Gateway Service - REST API for CLI commands (Port 50023)
  cli-gateway:
    build:
      context: .
      dockerfile: Dockerfile.cli-gateway
    image: aunsorm-cli-gateway:local
    ports:
      - "50023:50023"
    networks:
      - aunsorm-network
    depends_on:
      - auth-service
      - crypto-service
      - x509-service
    environment:
      - AUNSORM_LISTEN=0.0.0.0:50023
      - SERVICE_MODE=cli-gateway
      - CLI_MAX_FILE_SIZE=100MB
      - CLI_TIMEOUT=300s
      - AUTH_SERVICE_URL=http://auth-service:50011
    restart: unless-stopped

volumes:
  aunsorm-auth-data:
    driver: local
  aunsorm-mdm-data:
    driver: local
  aunsorm-acme-data:
    driver: local
  aunsorm-e2ee-data:
    driver: local
